generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "public"), vector]
}

model Tenant {
  id              String             @id @default(uuid())
  name            String
  slug            String             @unique
  contactEmail    String?
  archivePolicyId String?
  metadata        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  agentSettings   Json?
  components      Component[]
  files           File[]
  ingestionJobs   IngestionJob[]
  maintenance     MaintenanceEvent[]
  Node            Node[]
  nodeApiKeys     NodeApiKey[]
  projects        Project[]
  RuleSet         RuleSet[]
  tasks           Task[]
  audits          Audit[]
  archivePolicy   ArchivePolicy?     @relation(fields: [archivePolicyId], references: [id])
  users           User[]
}

model ArchivePolicy {
  id              String    @id @default(uuid())
  name            String
  description     String?
  hotStorageDays  Int       @default(90)
  coldStorageDays Int?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  projects        Project[]
  tenants         Tenant[]
}

model User {
  id                     String              @id @default(uuid())
  tenantId               String
  email                  String              @unique
  name                   String?
  role                   String
  status                 String              @default("ACTIVE")
  metadata               Json?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  nodeRevisions          NodeRevision[]      @relation("NodeRevisionAuthor")
  createdRequirements    RequirementsModel[] @relation("RequirementsModelCreatedBy")
  createdRuleEvaluations RuleEvaluation[]    @relation("RuleEvaluationCreatedBy")
  ruleOverrides          RuleOverride[]
  tasks                  Task[]              @relation("TaskAssignee")
  tenant                 Tenant              @relation(fields: [tenantId], references: [id])
}

model Project {
  id                       String                       @id @default(uuid())
  tenantId                 String
  archivePolicyId          String?
  externalId               String?                      @unique
  name                     String
  clientName               String?
  status                   String                       @default("ACTIVE")
  address                  String?
  medium                   String?
  psValue                  Float?
  volume                   Float?
  commissionedAt           DateTime?
  decommissionedAt         DateTime?
  metadata                 Json?
  facts                    Json?
  createdAt                DateTime                     @default(now())
  updatedAt                DateTime                     @updatedAt
  tsValue                  Float?
  installerCompany         String?
  offerNumber              String?
  orderNumber              String?
  projectManager           String?
  projectNumber            String?
  siteAddress              String?
  siteName                 String?
  components               Component[]
  documentationAttachments DocumentationAttachment[]
  documentationFiles       DocumentationGeneratedFile[]
  files                    File[]
  ingestionJobs            IngestionJob[]
  maintenance              MaintenanceEvent[]
  nodes                    Node[]
  nodeApiKeys              NodeApiKey[]
  archivePolicy            ArchivePolicy?               @relation(fields: [archivePolicyId], references: [id])
  tenant                   Tenant                       @relation(fields: [tenantId], references: [id])
  factsEntries             ProjectFact[]
  requirements             RequirementsModel[]
  ruleEvaluations          RuleEvaluation[]
  ruleOverrides            RuleOverride[]
  ruleSets                 RuleSet[]
  tasks                    Task[]
  audits                   Audit[]
}

model DocumentationAttachment {
  id               String             @id @default(uuid())
  projectId        String
  originalFileName String
  storedPath       String
  category         AttachmentCategory
  description      String?
  uploadedAt       DateTime           @default(now())
  project          Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model DocumentationGeneratedFile {
  id           String              @id @default(uuid())
  projectId    String
  relativePath String
  storagePath  String
  fileType     GeneratedFileType
  source       GeneratedFileSource
  description  String?
  mimeType     String?
  createdAt    DateTime            @default(now())
  project      Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, relativePath])
  @@index([projectId])
}

model Audit {
  id        String      @id @default(uuid())
  tenantId  String
  projectId String?
  name      String
  standard  String
  type      String
  scope     String?
  owner     String?
  status    AuditStatus @default(PLANNED)
  startDate DateTime
  endDate   DateTime
  metadata  Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  checklist AuditChecklistItem[]
  findings  AuditFinding[]
  actions   AuditAction[]

  @@index([tenantId])
  @@index([projectId])
  @@index([tenantId, status])
}

model AuditChecklistItem {
  id         String               @id @default(uuid())
  auditId    String
  clause     String?
  title      String
  owner      String?
  status     AuditChecklistStatus @default(COMPLIANT)
  notes      String?
  orderIndex Int                  @default(0)
  metadata   Json?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
}

model AuditFinding {
  id          String               @id @default(uuid())
  auditId     String
  title       String
  severity    AuditFindingSeverity @default(MEDIUM)
  owner       String?
  dueDate     DateTime?
  status      AuditStatus          @default(PLANNED)
  description String?
  metadata    Json?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([auditId, status])
}

model AuditAction {
  id          String            @id @default(uuid())
  auditId     String
  title       String
  owner       String?
  status      AuditActionStatus @default(OPEN)
  dueDate     DateTime?
  description String?
  metadata    Json?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([auditId, status])
}

model ProjectFact {
  id        String   @id @default(uuid())
  projectId String
  key       String
  value     Json
  source    String?
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id])

  @@unique([projectId, key])
}

model ComponentType {
  id              String      @id @default(uuid())
  code            String      @unique
  name            String
  category        String
  description     String?
  defaultFacts    Json?
  defaultMetadata Json?
  fields          Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  components      Component[]
}

model Component {
  id                String             @id @default(uuid())
  tenantId          String
  projectId         String
  componentTypeId   String
  name              String
  tag               String?
  serialNumber      String?
  manufacturer      String?
  installDate       DateTime?
  status            String             @default("ACTIVE")
  metadata          Json?
  facts             Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  componentType     ComponentType      @relation(fields: [componentTypeId], references: [id])
  project           Project            @relation(fields: [projectId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  maintenanceEvents MaintenanceEvent[]
  nodes             Node[]

  @@index([projectId])
  @@index([tenantId])
  @@index([componentTypeId])
}

model Node {
  id                  String                     @id @default(uuid())
  tenantId            String
  projectId           String
  type                String
  title               String
  status              NodeStatus                 @default(DRAFT)
  templateCode        String?
  templateVersion     String?
  snapshotId          String?
  currentRevisionId   String?                    @unique
  data                Json?
  facts               Json?
  metadata            Json?
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  componentId         String?
  externalAccess      Boolean                    @default(false)
  kiuvaSignatures     Json?
  kiuvaStatus         Json?
  documentSegments    DocumentSegment[]
  files               File[]
  generationSnapshots GenerationSnapshot[]
  ingestionJobs       IngestionJob[]
  maintenanceLinks    MaintenanceEventDocument[]
  component           Component?                 @relation(fields: [componentId], references: [id])
  currentRevision     NodeRevision?              @relation("NodeCurrentRevision", fields: [currentRevisionId], references: [id])
  project             Project                    @relation(fields: [projectId], references: [id])
  tenant              Tenant                     @relation(fields: [tenantId], references: [id])
  apiKeys             NodeApiKey[]
  outboundEdges       NodeEdge[]                 @relation("NodeEdgeFrom")
  inboundEdges        NodeEdge[]                 @relation("NodeEdgeTo")
  revisions           NodeRevision[]             @relation("NodeToRevision")
  tasks               Task[]

  @@index([tenantId])
  @@index([projectId])
  @@index([componentId])
}

model NodeEdge {
  id         String   @id @default(uuid())
  fromNodeId String
  toNodeId   String
  edgeType   String
  metadata   Json?
  createdAt  DateTime @default(now())
  fromNode   Node     @relation("NodeEdgeFrom", fields: [fromNodeId], references: [id])
  toNode     Node     @relation("NodeEdgeTo", fields: [toNodeId], references: [id])

  @@unique([fromNodeId, toNodeId, edgeType])
  @@index([fromNodeId])
  @@index([toNodeId])
}

model NodeRevision {
  id             String                 @id @default(uuid())
  nodeId         String
  revisionNumber Int
  changeType     NodeRevisionChangeType @default(INITIAL)
  severity       NodeRevisionSeverity   @default(NONE)
  summary        String?
  payload        Json?
  createdById    String?
  createdAt      DateTime               @default(now())
  newData        Json?
  previousData   Json?
  segments       DocumentSegment[]
  snapshot       GenerationSnapshot?
  currentFor     Node?                  @relation("NodeCurrentRevision")
  createdBy      User?                  @relation("NodeRevisionAuthor", fields: [createdById], references: [id])
  node           Node                   @relation("NodeToRevision", fields: [nodeId], references: [id])

  @@unique([nodeId, revisionNumber])
}

model File {
  id                 String            @id @default(uuid())
  tenantId           String
  projectId          String?
  nodeId             String?
  maintenanceEventId String?
  fileName           String
  storageKey         String
  mimeType           String
  size               Int
  checksum           String?
  status             String            @default("STORED")
  source             String?
  metadata           Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  externalReference  String?
  originalUrl        String?
  uploadedBy         String?
  isManufacturerDoc  Boolean           @default(false)
  manufacturerName   String?
  productModel       String?
  legalClass         LegalClass        @default(A)
  ingestionMode      IngestionMode     @default(FULLTEXT)
  maintenanceEvent   MaintenanceEvent? @relation(fields: [maintenanceEventId], references: [id])
  node               Node?             @relation(fields: [nodeId], references: [id])
  project            Project?          @relation(fields: [projectId], references: [id])
  tenant             Tenant            @relation(fields: [tenantId], references: [id])
  variants           FileVariant[]
  ingestionJobs      IngestionJob[]
}

model FileVariant {
  id          String          @id @default(uuid())
  fileId      String
  variantType FileVariantType
  storageKey  String
  mimeType    String
  size        Int?
  checksum    String?
  metadata    Json?
  createdAt   DateTime        @default(now())
  url         String
  file        File            @relation(fields: [fileId], references: [id])

  @@unique([fileId, variantType])
}

model IngestionJob {
  id            String             @id @default(uuid())
  tenantId      String
  projectId     String?
  nodeId        String?
  fileId        String?
  jobType       IngestionJobType   @default(NORMALIZE_FILE)
  status        IngestionJobStatus @default(PENDING)
  attempts      Int                @default(0)
  lastError     String?
  metadata      Json?
  correlationId String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  file          File?              @relation(fields: [fileId], references: [id])
  node          Node?              @relation(fields: [nodeId], references: [id])
  project       Project?           @relation(fields: [projectId], references: [id])
  tenant        Tenant             @relation(fields: [tenantId], references: [id])

  @@index([fileId])
  @@index([projectId])
  @@index([nodeId])
}

model MaintenanceEvent {
  id          String                     @id @default(uuid())
  tenantId    String
  projectId   String
  componentId String?
  performedAt DateTime?
  performedBy String?
  eventType   String
  status      MaintenanceEventStatus     @default(RECEIVED)
  source      MaintenanceEventSource     @default(INTERNAL_APP)
  rawPayload  Json
  notes       Json?
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  attachments File[]
  component   Component?                 @relation(fields: [componentId], references: [id])
  project     Project                    @relation(fields: [projectId], references: [id])
  tenant      Tenant                     @relation(fields: [tenantId], references: [id])
  documents   MaintenanceEventDocument[]
  tasks       Task[]
}

model MaintenanceEventDocument {
  id                 String           @id @default(uuid())
  maintenanceEventId String
  nodeId             String
  linkType           String           @default("RELATED")
  metadata           Json?
  createdAt          DateTime         @default(now())
  maintenanceEvent   MaintenanceEvent @relation(fields: [maintenanceEventId], references: [id])
  node               Node             @relation(fields: [nodeId], references: [id])

  @@unique([maintenanceEventId, nodeId, linkType])
}

model Task {
  id                 String            @id @default(uuid())
  tenantId           String
  projectId          String
  nodeId             String?
  maintenanceEventId String?
  type               String
  status             TaskStatus        @default(PENDING)
  title              String
  description        String?
  metadata           Json?
  dueAt              DateTime?
  assigneeId         String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  priority           Int               @default(5)
  taskTemplateId     String?
  assignee           User?             @relation("TaskAssignee", fields: [assigneeId], references: [id])
  maintenanceEvent   MaintenanceEvent? @relation(fields: [maintenanceEventId], references: [id])
  node               Node?             @relation(fields: [nodeId], references: [id])
  project            Project           @relation(fields: [projectId], references: [id])
  template           TaskTemplate?     @relation(fields: [taskTemplateId], references: [id])
  tenant             Tenant            @relation(fields: [tenantId], references: [id])
  runs               TaskRun[]
}

model TaskRun {
  id         String    @id @default(uuid())
  taskId     String
  agent      String
  status     String
  input      Json?
  output     Json?
  error      String?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  metadata   Json?
  task       Task      @relation(fields: [taskId], references: [id])
}

model RuleSet {
  id          String       @id @default(uuid())
  tenantId    String?
  projectId   String?
  scope       RuleSetScope @default(GLOBAL)
  code        String
  title       String
  description String?
  version     String
  metadata    Json?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  rules       Rule[]
  project     Project?     @relation(fields: [projectId], references: [id])
  tenant      Tenant?      @relation(fields: [tenantId], references: [id])

  @@unique([code, version, tenantId, projectId])
}

model Rule {
  id          String         @id @default(uuid())
  ruleSetId   String
  code        String
  description String?
  severity    String
  appliesTo   Json?
  condition   Json?
  outcome     Json?
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  ruleSet     RuleSet        @relation(fields: [ruleSetId], references: [id])
  hits        RuleHit[]
  overrides   RuleOverride[]
  sources     RuleSource[]
}

model RuleSource {
  id        String   @id @default(uuid())
  ruleId    String
  title     String
  reference String?
  url       String?
  metadata  Json?
  createdAt DateTime @default(now())
  rule      Rule     @relation(fields: [ruleId], references: [id])
}

model RuleOverride {
  id          String         @id @default(uuid())
  projectId   String
  ruleId      String
  status      String
  notes       String?
  metadata    Json?
  createdById String?
  createdAt   DateTime       @default(now())
  conflicts   RuleConflict[] @relation("RuleOverrideConflicts")
  createdBy   User?          @relation(fields: [createdById], references: [id])
  project     Project        @relation(fields: [projectId], references: [id])
  rule        Rule           @relation(fields: [ruleId], references: [id])
}

model RuleEvaluation {
  id           String               @id @default(uuid())
  projectId    String
  scope        String               @default("FULL")
  status       RuleEvaluationStatus @default(PENDING)
  facts        Json
  summary      Json?
  createdById  String?
  startedAt    DateTime             @default(now())
  completedAt  DateTime?
  requirements RequirementsModel?   @relation("EvaluationToRequirements")
  conflicts    RuleConflict[]
  createdBy    User?                @relation("RuleEvaluationCreatedBy", fields: [createdById], references: [id])
  project      Project              @relation(fields: [projectId], references: [id])
  hits         RuleHit[]
}

model RuleHit {
  id               String         @id @default(uuid())
  ruleEvaluationId String
  ruleId           String?
  ruleCode         String?
  severity         String?
  outcome          Json?
  metadata         Json?
  createdAt        DateTime       @default(now())
  evaluation       RuleEvaluation @relation(fields: [ruleEvaluationId], references: [id], onDelete: Cascade)
  rule             Rule?          @relation(fields: [ruleId], references: [id])
}

model RuleConflict {
  id                   String             @id @default(uuid())
  ruleEvaluationId     String
  ruleAId              String?
  ruleACode            String?
  ruleBId              String?
  ruleBCode            String?
  conflictType         String
  status               RuleConflictStatus @default(OPEN)
  message              String?
  metadata             Json?
  resolvedByOverrideId String?
  resolvedAt           DateTime?
  createdAt            DateTime           @default(now())
  resolvedBy           RuleOverride?      @relation("RuleOverrideConflicts", fields: [resolvedByOverrideId], references: [id])
  evaluation           RuleEvaluation     @relation(fields: [ruleEvaluationId], references: [id], onDelete: Cascade)
}

model GenerationSnapshot {
  id             String            @id @default(uuid())
  nodeId         String
  nodeRevisionId String?           @unique
  snapshotType   String            @default("DOCUMENT")
  payload        Json
  ruleSetHash    String?
  createdAt      DateTime          @default(now())
  segments       DocumentSegment[]
  node           Node              @relation(fields: [nodeId], references: [id])
  nodeRevision   NodeRevision?     @relation(fields: [nodeRevisionId], references: [id])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model DocumentSegment {
  id             String                      @id @default(uuid())
  nodeId         String
  snapshotId     String?
  nodeRevisionId String?
  orderIndex     Int
  segmentType    String
  content        String
  embedding      Unsupported("vector")?
  metadata       Json?
  createdAt      DateTime                    @default(now())
  node           Node                        @relation(fields: [nodeId], references: [id])
  revision       NodeRevision?               @relation(fields: [nodeRevisionId], references: [id])
  snapshot       GenerationSnapshot?         @relation(fields: [snapshotId], references: [id])
  provenance     DocumentSegmentProvenance[]
}

model DocumentSegmentProvenance {
  id         String          @id @default(uuid())
  segmentId  String
  sourceType String
  sourceId   String?
  score      Float?
  metadata   Json?
  createdAt  DateTime        @default(now())
  segment    DocumentSegment @relation(fields: [segmentId], references: [id])
}

model NodeApiKey {
  id                 String         @id @default(uuid())
  tenantId           String
  projectId          String?
  nodeId             String?
  name               String
  tokenHash          String         @unique
  scope              ApiKeyScope    @default(PROJECT)
  isActive           Boolean        @default(true)
  rateLimitPerMinute Int?
  lastUsedAt         DateTime?
  metadata           Json?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  accessLevel        String         @default("READ")
  expiresAt          DateTime?
  maxCallsPerDay     Int?
  logs               ApiAccessLog[]
  node               Node?          @relation(fields: [nodeId], references: [id])
  project            Project?       @relation(fields: [projectId], references: [id])
  tenant             Tenant         @relation(fields: [tenantId], references: [id])
}

model ApiAccessLog {
  id           String     @id @default(uuid())
  nodeApiKeyId String
  path         String
  method       String
  statusCode   Int
  ipAddress    String?
  metadata     Json?
  createdAt    DateTime   @default(now())
  apiKey       NodeApiKey @relation(fields: [nodeApiKeyId], references: [id])
}

model RequirementsModel {
  id                  String          @id @default(uuid())
  projectId           String
  scope               String          @default("FULL")
  payload             Json
  version             Int             @default(1)
  warnings            Json?
  unresolvedConflicts Json?
  createdAt           DateTime        @default(now())
  createdById         String?
  metadata            Json?
  ruleEvaluationId    String?         @unique
  createdBy           User?           @relation("RequirementsModelCreatedBy", fields: [createdById], references: [id])
  project             Project         @relation(fields: [projectId], references: [id])
  ruleEvaluation      RuleEvaluation? @relation("EvaluationToRequirements", fields: [ruleEvaluationId], references: [id])
}

model DocumentTemplate {
  id          String   @id @default(uuid())
  code        String   @unique
  title       String
  description String?
  version     String
  schema      Json
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TaskTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  code        String
  name        String
  description String?
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tasks       Task[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model avvik {
  id                             String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                      String               @db.Uuid
  project_id                     String               @db.Uuid
  node_id                        String?              @db.Uuid
  checklist_instance_id          String?              @db.Uuid
  maintenance_event_id           String?              @db.Uuid
  type                           String?
  title                          String
  description                    String
  severity                       String
  status                         String               @default("OPEN")
  created_by                     String?              @db.Uuid
  assigned_to                    String?              @db.Uuid
  due_date                       DateTime?            @db.Date
  closed_at                      DateTime?            @db.Timestamptz(6)
  closed_by                      String?              @db.Uuid
  closure_comment                String?
  created_at                     DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at                     DateTime?            @default(now()) @db.Timestamptz(6)
  users_avvik_assigned_toTousers users?               @relation("avvik_assigned_toTousers", fields: [assigned_to], references: [id], onDelete: NoAction, onUpdate: NoAction)
  checklist_instances            checklist_instances? @relation(fields: [checklist_instance_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_avvik_closed_byTousers   users?               @relation("avvik_closed_byTousers", fields: [closed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_avvik_created_byTousers  users?               @relation("avvik_created_byTousers", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  maintenance_events             maintenance_events?  @relation(fields: [maintenance_event_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nodes                          nodes?               @relation(fields: [node_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects                       projects             @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                        tenants              @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  avvik_actions                  avvik_actions[]
}

model avvik_actions {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  avvik_id           String    @db.Uuid
  action_type        String
  comment            String?
  new_status         String?
  attachment_file_id String?   @db.Uuid
  linked_node_id     String?   @db.Uuid
  created_by         String?   @db.Uuid
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  files              files?    @relation(fields: [attachment_file_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  avvik              avvik     @relation(fields: [avvik_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users              users?    @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nodes              nodes?    @relation(fields: [linked_node_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model checklist_instances {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String              @db.Uuid
  project_id           String              @db.Uuid
  template_id          String              @db.Uuid
  node_id              String?             @db.Uuid
  maintenance_event_id String?             @db.Uuid
  status               String              @default("draft")
  filled_by            String?             @db.Uuid
  filled_at            DateTime?           @db.Timestamptz(6)
  data                 Json?
  created_at           DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?           @default(now()) @db.Timestamptz(6)
  avvik                avvik[]
  users                users?              @relation(fields: [filled_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  maintenance_events   maintenance_events? @relation(fields: [maintenance_event_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nodes                nodes?              @relation(fields: [node_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects             projects            @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  checklist_templates  checklist_templates @relation(fields: [template_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants              tenants             @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model checklist_templates {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String                @db.Uuid
  code                String
  name                String
  description         String?
  scope               String?
  schema              Json
  created_by          String?               @db.Uuid
  created_at          DateTime?             @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?             @default(now()) @db.Timestamptz(6)
  checklist_instances checklist_instances[]
  users               users?                @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants             tenants               @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model document_segment_provenance {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  segment_id           String               @db.Uuid
  snapshot_id          String               @db.Uuid
  rule_ids             String[]             @db.Uuid
  source_chunk_ids     String[]             @db.Uuid
  model_name           String?
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  document_segments    document_segments    @relation(fields: [segment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  generation_snapshots generation_snapshots @relation(fields: [snapshot_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model document_segments {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  node_id                     String                        @db.Uuid
  segment_type                String
  parent_segment_id           String?                       @db.Uuid
  text                        String
  start_char                  Int?
  end_char                    Int?
  created_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  document_segment_provenance document_segment_provenance[]
  nodes                       nodes                         @relation(fields: [node_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  document_segments           document_segments?            @relation("document_segmentsTodocument_segments", fields: [parent_segment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_document_segments     document_segments[]           @relation("document_segmentsTodocument_segments")
}

model document_chunks {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  file_variant_id String        @db.Uuid
  chunk_index     Int
  content         String
  embedding       Unsupported("vector")?
  metadata        Json?
  created_at      DateTime?     @default(now()) @db.Timestamptz(6)
  file_variants   file_variants @relation(fields: [file_variant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model file_variants {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  file_id      String    @db.Uuid
  variant_type String
  url          String
  metadata     Json?
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  files        files     @relation(fields: [file_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model files {
  id                 String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String          @db.Uuid
  project_id         String          @db.Uuid
  uploaded_by        String?         @db.Uuid
  source             String
  original_url       String
  mime_type          String
  size_bytes         BigInt?
  external_reference String?
  created_at         DateTime?       @default(now()) @db.Timestamptz(6)
  avvik_actions      avvik_actions[]
  file_variants      file_variants[]
  projects           projects        @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants            tenants         @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users              users?          @relation(fields: [uploaded_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model generation_snapshots {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                   String                        @db.Uuid
  project_id                  String                        @db.Uuid
  node_id                     String?                       @db.Uuid
  rule_set_versions           Json?
  used_document_ids           String[]                      @db.Uuid
  used_chunk_ids              String[]                      @db.Uuid
  facts                       Json?
  ai_model                    String?
  prompt_hash                 String?
  created_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  document_segment_provenance document_segment_provenance[]
  nodes                       nodes?                        @relation(fields: [node_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects                    projects                      @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                     tenants                       @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model maintenance_event_documents {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  maintenance_event_id String             @db.Uuid
  node_id              String             @db.Uuid
  created_at           DateTime?          @default(now()) @db.Timestamptz(6)
  maintenance_events   maintenance_events @relation(fields: [maintenance_event_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  nodes                nodes              @relation(fields: [node_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model maintenance_events {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                   String                        @db.Uuid
  project_id                  String                        @db.Uuid
  node_id                     String?                       @db.Uuid
  performed_by                String?
  source                      String
  performed_at                DateTime                      @db.Timestamptz(6)
  event_type                  String
  status                      String                        @default("RECEIVED")
  raw_payload                 Json?
  created_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  avvik                       avvik[]
  checklist_instances         checklist_instances[]
  maintenance_event_documents maintenance_event_documents[]
  projects                    projects                      @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                     tenants                       @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tasks                       tasks[]
}

model node_edges {
  id                                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                            String    @db.Uuid
  project_id                           String    @db.Uuid
  from_node_id                         String    @db.Uuid
  to_node_id                           String    @db.Uuid
  relation_type                        String
  created_at                           DateTime? @default(now()) @db.Timestamptz(6)
  nodes_node_edges_from_node_idTonodes nodes     @relation("node_edges_from_node_idTonodes", fields: [from_node_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  projects                             projects  @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                              tenants   @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nodes_node_edges_to_node_idTonodes   nodes     @relation("node_edges_to_node_idTonodes", fields: [to_node_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model node_revisions {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  node_id         String    @db.Uuid
  revision_number Int
  change_type     String
  severity        String?
  description     String?
  changed_by      String?   @db.Uuid
  previous_data   Json?
  new_data        Json?
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  users           users?    @relation(fields: [changed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nodes           nodes     @relation(fields: [node_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([node_id, revision_number], map: "node_revisions_node_idx")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model nodes {
  id                                        String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                 String                        @db.Uuid
  project_id                                String                        @db.Uuid
  type                                      String
  title                                     String
  status                                    String                        @default("draft")
  template_id                               String?
  data                                      Json?
  snapshot_id                               String?                       @db.Uuid
  created_by                                String?                       @db.Uuid
  created_at                                DateTime?                     @default(now()) @db.Timestamptz(6)
  updated_at                                DateTime?                     @default(now()) @db.Timestamptz(6)
  avvik                                     avvik[]
  avvik_actions                             avvik_actions[]
  checklist_instances                       checklist_instances[]
  document_segments                         document_segments[]
  generation_snapshots                      generation_snapshots[]
  maintenance_event_documents               maintenance_event_documents[]
  node_edges_node_edges_from_node_idTonodes node_edges[]                  @relation("node_edges_from_node_idTonodes")
  node_edges_node_edges_to_node_idTonodes   node_edges[]                  @relation("node_edges_to_node_idTonodes")
  node_revisions                            node_revisions[]
  users                                     users?                        @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects                                  projects                      @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                                   tenants                       @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tasks                                     tasks[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model projects {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String                 @db.Uuid
  name                 String
  address              String?
  customer_name        String?
  customer_type        String?
  medium               String?
  ps                   Decimal?               @db.Decimal
  volume_l             Decimal?               @db.Decimal
  commissioned_at      DateTime?              @db.Date
  decommissioned_at    DateTime?              @db.Date
  status               String                 @default("draft")
  external_id          String?
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  avvik                avvik[]
  checklist_instances  checklist_instances[]
  files                files[]
  generation_snapshots generation_snapshots[]
  maintenance_events   maintenance_events[]
  node_edges           node_edges[]
  nodes                nodes[]
  tenants              tenants                @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rule_overrides       rule_overrides[]
  tasks                tasks[]
}

model rule_overrides {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  base_rule_id       String    @db.Uuid
  tenant_id          String?   @db.Uuid
  project_id         String?   @db.Uuid
  override_type      String
  override_condition Json?
  override_outcome   Json?
  reason             String?
  created_by         String?   @db.Uuid
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  rules              rules     @relation(fields: [base_rule_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users              users?    @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects           projects? @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants            tenants?  @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model rule_sets {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String?   @db.Uuid
  name        String
  level       String
  version     String
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  tenants     tenants?  @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rules       rules[]
}

model rule_sources {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rule_id     String  @db.Uuid
  source_type String
  source_ref  String
  url         String?
  notes       String?
  rules       rules   @relation(fields: [rule_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model rules {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rule_set_id    String           @db.Uuid
  code           String
  description    String?
  severity       String?
  applies_to     String?
  condition      Json
  outcome        Json
  created_at     DateTime?        @default(now()) @db.Timestamptz(6)
  rule_overrides rule_overrides[]
  rule_sources   rule_sources[]
  rule_sets      rule_sets        @relation(fields: [rule_set_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model task_runs {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  task_id     String    @db.Uuid
  step        String
  status      String
  started_at  DateTime? @db.Timestamptz(6)
  finished_at DateTime? @db.Timestamptz(6)
  log         Json?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  tasks       tasks     @relation(fields: [task_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model task_templates {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String    @db.Uuid
  code        String
  name        String
  description String?
  config      Json?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  tenants     tenants   @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tasks       tasks[]
}

model tasks {
  id                             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                      String              @db.Uuid
  project_id                     String              @db.Uuid
  task_template_id               String?             @db.Uuid
  code                           String
  node_id                        String?             @db.Uuid
  maintenance_event_id           String?             @db.Uuid
  status                         String              @default("OPEN")
  priority                       Int?                @default(5)
  assigned_to                    String?             @db.Uuid
  created_by                     String?             @db.Uuid
  created_at                     DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at                     DateTime?           @default(now()) @db.Timestamptz(6)
  meta                           Json?
  task_runs                      task_runs[]
  users_tasks_assigned_toTousers users?              @relation("tasks_assigned_toTousers", fields: [assigned_to], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_tasks_created_byTousers  users?              @relation("tasks_created_byTousers", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  maintenance_events             maintenance_events? @relation(fields: [maintenance_event_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nodes                          nodes?              @relation(fields: [node_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects                       projects            @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  task_templates                 task_templates?     @relation(fields: [task_template_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                        tenants             @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model tenants {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  avvik                avvik[]
  checklist_instances  checklist_instances[]
  checklist_templates  checklist_templates[]
  files                files[]
  generation_snapshots generation_snapshots[]
  maintenance_events   maintenance_events[]
  node_edges           node_edges[]
  nodes                nodes[]
  projects             projects[]
  rule_overrides       rule_overrides[]
  rule_sets            rule_sets[]
  task_templates       task_templates[]
  tasks                tasks[]
  users                users[]
}

model users {
  id                             String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                      String                @db.Uuid
  email                          String                @unique
  name                           String?
  role                           String                @default("user")
  created_at                     DateTime?             @default(now()) @db.Timestamptz(6)
  avvik_avvik_assigned_toTousers avvik[]               @relation("avvik_assigned_toTousers")
  avvik_avvik_closed_byTousers   avvik[]               @relation("avvik_closed_byTousers")
  avvik_avvik_created_byTousers  avvik[]               @relation("avvik_created_byTousers")
  avvik_actions                  avvik_actions[]
  checklist_instances            checklist_instances[]
  checklist_templates            checklist_templates[]
  files                          files[]
  node_revisions                 node_revisions[]
  nodes                          nodes[]
  rule_overrides                 rule_overrides[]
  tasks_tasks_assigned_toTousers tasks[]               @relation("tasks_assigned_toTousers")
  tasks_tasks_created_byTousers  tasks[]               @relation("tasks_created_byTousers")
  tenants                        tenants               @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

enum NodeStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  ARCHIVED
}

enum NodeRevisionChangeType {
  INITIAL
  EDIT
  MAINTENANCE_UPDATE
  OVERRIDE
  AI_GENERATION
}

enum NodeRevisionSeverity {
  NONE
  NOTE
  VARSEL
}

enum FileVariantType {
  ORIGINAL
  NORMALIZED_PDF
  PLAIN_TEXT
  STRUCTURED_JSON
}

enum LegalClass {
  A
  B
  C
}

enum IngestionMode {
  FULLTEXT
  FULLTEXT_INTERNAL_ONLY
  METADATA_ONLY
}

enum IngestionJobType {
  NORMALIZE_FILE
  EXTRACT_TEXT
  BUILD_STRUCTURED
  INDEX_EMBEDDINGS
}

enum IngestionJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum MaintenanceEventStatus {
  RECEIVED
  PARSED
  NEEDS_REVIEW
  COMPLETED
}

enum MaintenanceEventSource {
  INTERNAL_APP
  EXTERNAL_API
  EMAIL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  PENDING_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

enum AuditStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
}

enum AuditChecklistStatus {
  COMPLIANT
  NC
  OBS
}

enum AuditFindingSeverity {
  HIGH
  MEDIUM
  LOW
}

enum AuditActionStatus {
  OPEN
  IN_PROGRESS
  VERIFY
  CLOSED
}

enum AttachmentCategory {
  MANUFACTURER_DOC
  CHECKLIST
  ORDER_DOC
  OTHER
}

enum GeneratedFileType {
  DOCX
  PDF
  MD
  TXT
  XLSX
}

enum GeneratedFileSource {
  AI_GENERATED
  USER_UPLOADED
  COPIED
}

enum RuleSetScope {
  GLOBAL
  TENANT
  CUSTOMER
  PROJECT
}

enum RuleEvaluationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum RuleConflictStatus {
  OPEN
  RESOLVED
  IGNORED
}

enum ApiKeyScope {
  PROJECT
  NODE
}
